{% extends 'base.html' %}
{% block title %}AI Chat{% endblock %}
{% block content %}
<div class="container fade-in-up ">
<div class="row">
  <div class="col-md-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Conversations</h5>
      <button class="btn btn-sm btn-primary" id="newChatBtn">New Chat</button>
    </div>

    <!-- Avatar display (uploads moved to Edit profile page) -->
    <div class="mb-3 d-flex align-items-center gap-2">
      {% if profile and profile.avatar %}
        <div class="circle-transparent chat-avatar">
            <img src="{{ profile.avatar.url }}" alt="avatar">
        </div>
      {% else %}
        <div class="circle-transparent chat-avatar d-inline-flex align-items-center justify-content-center" style="font-weight:600">{% if profile %}{{ profile.initials }}{% else %}{{ user.username|slice:":1"|upper }}{% endif %}</div>
      {% endif %}

    </div>
    <div id="conversations" class="list-group" style="max-height:70vh; overflow:auto;">
      {% for chat in chats %}
        <a href="#" class="list-group-item list-group-item-action chat-item" data-session-id="{{ chat.session_id }}">
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1 small text-truncate">{{ chat.first_message|default:'(empty)'|truncatechars:60 }}</h6>
            <small class="text-muted">{{ chat.last_timestamp|date:"M d, H:i" }}</small>
          </div>
          <p class="mb-1 small text-muted text-truncate">{{ chat.preview|default:'' }}</p>
        </a>
        
      {% empty %}
        <div class="text-muted small">No conversations yet. Click "New Chat" to start.</div>
      {% endfor %}
    </div>
  </div>

  <div class="col-md-8">
    <div class="card chat-card" style="height:75vh; display:flex; flex-direction:column;">
      <div class="card-body p-3" id="chatPane" style="overflow:auto; flex:1 1 auto;">
        <div id="messages" class="mb-2"></div>
      </div>

      <div class="card-footer chat-footer">
        <div class="input-group">
          <input type="text" id="userMessage" class="form-control" placeholder="Type your question...">
          <button class="btn btn-success" id="sendBtn">Send</button>
          <button class="btn btn-outline-danger" id="deleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
const csrfToken = '{{ csrf_token }}';
const profileAvatarUrl = {% if profile and profile.avatar %}'{{ profile.avatar.url }}'{% else %}null{% endif %};
const profileInitials = {% if profile %}'{{ profile.initials }}'{% else %}'{{ user.username|slice:":1"|upper }}'{% endif %};
let currentChatId = null;
let isNewSession = false; // true when user clicked New Chat and the next send should create a sidebar entry

async function loadConversations() {
  // conversation list already rendered server-side; just attach handlers
  document.querySelectorAll('.chat-item').forEach(el => attachChatItemHandler(el));
}

function attachChatItemHandler(el) {
  // remove existing listener by cloning and replacing to avoid duplicate handlers
  const newEl = el.cloneNode(true);
  el.parentNode.replaceChild(newEl, el);
  newEl.addEventListener('click', async (e) => {
    e.preventDefault();
    const sid = newEl.dataset.sessionId;
    isNewSession = false;
    await selectChat(sid);
  });
}

async function selectChat(sessionId) {
  currentChatId = sessionId;
  // fetch chat details for session
  const res = await fetch(`{% url 'chat_get' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', sessionId));
  const data = await res.json();
  const messages = document.getElementById('messages');
  messages.innerHTML = '';
  // server returns the full message list for the session
    for (const m of data.messages) {
      // user message bubble with avatar/initials
      const userAvatarHtml = profileAvatarUrl ? (`<img src="${profileAvatarUrl}" class="rounded-circle" width="32" height="32" style="object-fit:cover;margin-right:8px;">`) : (`<div class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" style="width:32px;height:32px;font-weight:600;margin-right:8px;">${profileInitials}</div>`);
      // user bubble
      messages.innerHTML += `<div class="msg-row user"><div class="chat-bubble user">${escapeHtml(m.user_message)}</div><div class="meta">${userAvatarHtml}</div></div>`;
      // ai bubble
      messages.innerHTML += `<div class="msg-row"><div class="meta"></div><div class="chat-bubble ai">${marked.parse(escapeHtml(m.bot_response))}</div></div>`;
    }
  scrollChatToBottom();
}

async function sendMessage() {
  const input = document.getElementById('userMessage');
  const message = input.value.trim();
  if (!message) return;

  // show optimistic user message
  const messages = document.getElementById('messages');
  const userAvatarHtml = profileAvatarUrl ? (`<img src="${profileAvatarUrl}" class="rounded-circle" width="32" height="32" style="object-fit:cover;margin-right:8px;">`) : (`<div class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" style="width:32px;height:32px;font-weight:600;margin-right:8px;">${profileInitials}</div>`);
  messages.innerHTML += `<div class="msg-row user"><div class="chat-bubble user">${escapeHtml(message)}</div><div class="meta">${userAvatarHtml}</div></div>`;
  scrollChatToBottom();

  const res = await fetch("{% url 'chatbot_api' %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken,
    },
    body: JSON.stringify({ message, session_id: currentChatId })
  });
  const data = await res.json();
  if (data.error) {
    messages.innerHTML += `<div class="text-danger"><strong>Error:</strong> ${escapeHtml(data.error)}</div>`;
  } else {
  messages.innerHTML += `<div class="msg-row"><div class="meta"></div><div class="chat-bubble ai">${marked.parse(escapeHtml(data.reply))}</div></div>`;
    // set or update the active session id
    if (data.session_id) {
      // Set current session
      const sid = data.session_id;
      if (isNewSession) {
        currentChatId = sid;
        addConversationToSidebar(sid, message, data.reply);
        isNewSession = false;
      } else {
        // existing session â€” update preview/time
        currentChatId = sid;
        const updated = updateConversationEntry(sid, message, data.reply);
        if (!updated) {
          // fallback: add if no existing element
          addConversationToSidebar(sid, message, data.reply);
        }
      }
    }
  }
  input.value = '';
  scrollChatToBottom();
}

function addConversationToSidebar(id, userMsg, botResp) {
  const container = document.getElementById('conversations');
  // If entries for this session already exist, keep only the first and remove duplicates
  const selector = `.chat-item[data-session-id="${id}"]`;
  const existingNodes = Array.from(container.querySelectorAll(selector));
  let existing = existingNodes.length > 0 ? existingNodes[0] : null;
  if (existingNodes.length > 1) {
    // remove duplicates beyond the first
    for (let i = 1; i < existingNodes.length; i++) {
      existingNodes[i].remove();
    }
  }
  const html = `<div style="display:flex;align-items:center;gap:8px;"><div class=\"conversation-circle\">${escapeHtml(userMsg || '').charAt(0) || 'C'}</div><div><div style=\"font-weight:700;\">${escapeHtml(userMsg).substring(0,20)}</div><div class=\"preview\">${escapeHtml(botResp).substring(0,60)}</div></div></div>`;
  if (existing) {
  // update content
  existing.innerHTML = html;
  // move to top
  container.prepend(existing);
  // reattach handler to ensure it's correct
  attachChatItemHandler(existing);
  } else {
  const a = document.createElement('a');
  a.className = 'list-group-item list-group-item-action chat-item active';
  a.dataset.sessionId = id;
  a.href = '#';
  a.innerHTML = html;
    // prepend and attach handler
    container.prepend(a);
    attachChatItemHandler(a);
  }
  // set as current and load messages
  selectChat(id);
}

function updateConversationEntry(id, userMsg, botResp) {
  const container = document.getElementById('conversations');
  const selector = `.chat-item[data-session-id="${id}"]`;
  const existingNodes = Array.from(container.querySelectorAll(selector));   
  if (existingNodes.length === 0) return false;
  const existing = existingNodes[0];
  // Update preview paragraph
  const previewP = existing.querySelector('p');
  if (previewP) previewP.textContent = botResp ? botResp.substring(0, 120) + (botResp.length > 120 ? '...' : '') : '';
  const small = existing.querySelector('small');
  if (small) small.textContent = 'Now';
  
  container.prepend(existing);
  attachChatItemHandler(existing);
  return true;
}

async function deleteCurrentChat() {
  if (!currentChatId) return;
  if (!confirm('Delete this conversation?')) return;
  const res = await fetch(`{% url 'chat_delete' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', `${currentChatId}`), {
    method: 'POST', headers: {'X-CSRFToken': csrfToken}
  });
  const data = await res.json();
  if (data.deleted) {
    const el = document.querySelector(`.chat-item[data-session-id="${currentChatId}"]`);
    if (el) el.remove();
    currentChatId = null;
    document.getElementById('messages').innerHTML = '';
  }
}

function newChat() {
  currentChatId = null;
  isNewSession = true;
  document.getElementById('messages').innerHTML = '';
}

function scrollChatToBottom() {
  const pane = document.getElementById('chatPane');
  pane.scrollTop = pane.scrollHeight;
}

function escapeHtml(text) {
  var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return String(text).replace(/[&<>\"']/g, function(m) { return map[m]; });
}

document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('userMessage').addEventListener('keydown', function(e){ if(e.key === 'Enter') { sendMessage(); }});
document.getElementById('deleteBtn').addEventListener('click', deleteCurrentChat);
document.getElementById('newChatBtn').addEventListener('click', newChat);

loadConversations();
</script>


{% endblock %}
