{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "My Allergies" %}{% endblock %}

{% block content %}
    <div class="page-viewport">
        
                <div class="page-card fade-in-up card chat-card">
                    <div class="card-body">
                        <h2 class="mb-4 ">{% trans "My Allergies" %}</h2>
    {% if allergy %}
        <h5>Edit allergy</h5>
        <form method="post" class="mb-3" action="{% url 'edit_allergy' allergy.pk %}">
            {% csrf_token %}
            <div class="mb-3">
                <label for="name" class="form-label">Allergy name</label>
                <input type="text" class="form-control" id="name" name="name" value="{{ allergy.name }}">
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3">{{ allergy.description }}</textarea>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
            <a href="{% url 'allergies' %}" class="btn btn-secondary">Cancel</a>
        </form>
        
    {% else %}
        <form method="post" class="mb-3" action="{% url 'add_allergy' %}">
            {% csrf_token %}
            <div class="mb-3">
                <label for="allergies" class="form-label">{% trans "List your allergies (comma-separated):" %}</label>
                <input type="text" class="form-control" id="allergies" name="allergies" placeholder="e.g. peanuts, shellfish, gluten">
            </div>
            <button type="submit" class="btn btn-primary">Save Allergies</button>
        </form>
    {% endif %}
    {% if message %}
        <div class="alert alert-success">{{ message }}</div>
    {% endif %}
            <hr>
            <script>
                document.addEventListener('DOMContentLoaded', function(){
                    const panel = document.getElementById('allergyDetails');
                    const titleEl = document.getElementById('allergyDetailsTitle');
                    const bodyEl = document.getElementById('allergyDetailsBody');
                    const editLink = document.createElement('a');
                    editLink.className = 'btn btn-sm btn-outline-light me-2';
                    editLink.id = 'allergyEditLink';
                    editLink.textContent = '{% trans "Edit" %}';
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.id = 'allergyDeleteBtn';
                    deleteBtn.textContent = '{% trans "Delete" %}';

                    // insert controls into panel header if panel exists
                    if (panel) {
                        // ensure header container exists
                        const header = document.createElement('div');
                        header.style.display = 'flex';
                        header.style.justifyContent = 'space-between';
                        header.style.alignItems = 'center';
                        header.style.gap = '12px';
                        header.style.marginBottom = '8px';
                        const titleWrap = document.createElement('div');
                        titleWrap.appendChild(titleEl);
                        const actions = document.createElement('div');
                        actions.appendChild(editLink);
                        actions.appendChild(deleteBtn);
                        header.appendChild(titleWrap);
                        header.appendChild(actions);
                        // place header before body
                        panel.insertBefore(header, panel.firstChild);
                    }

                    function getCookie(name) { let v = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v ? v.pop() : ''; }

                    document.querySelectorAll('.allergy-circle').forEach(el => {
                        el.addEventListener('click', () => {
                            const alreadyActive = el.classList.contains('active');
                            // remove active from others
                            document.querySelectorAll('.allergy-circle.active').forEach(a => a.classList.remove('active'));
                            if (alreadyActive) {
                                if (panel) panel.style.display = 'none';
                                el.classList.remove('active');
                                return;
                            }
                            el.classList.add('active');

                            const title = el.querySelector('.label') ? el.querySelector('.label').innerText : '';
                            const desc = el.dataset.description || 'No description available.';
                            const aid = el.dataset.allergyId;
                            if (titleEl) titleEl.innerText = title;
                            if (bodyEl) bodyEl.innerText = desc;
                            if (panel) panel.style.display = 'block';

                            // set edit link and delete handler
                            if (editLink) editLink.href = `/allergies/${aid}/edit/`;
                            if (deleteBtn) {
                                deleteBtn.onclick = async function(){
                                    if (!confirm('{% trans "Delete this allergy?" %}')) return;
                                    try {
                                        const csrftoken = getCookie('csrftoken');
                                        // Build URL that preserves language prefix (i18n_patterns)
                                        const parts = window.location.pathname.split('/');
                                        const langCandidate = parts[1];
                                        const supportedLangs = ['en','ar'];
                                        const prefix = supportedLangs.includes(langCandidate) ? '/' + langCandidate : '';
                                        const deleteUrl = `${prefix}/allergies/${aid}/delete/`;
                                        // ensure same-origin cookies are sent
                                        const res = await fetch(deleteUrl, { method: 'POST', credentials: 'same-origin', headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'} });
                                        if (res.ok) {
                                            // try to parse JSON (server returns {deleted: true})
                                            try {
                                                const j = await res.json();
                                                if (j && j.deleted) {
                                                    el.remove();
                                                    if (panel) panel.style.display = 'none';
                                                } else {
                                                    // fallback: remove if response OK
                                                    el.remove();
                                                    if (panel) panel.style.display = 'none';
                                                }
                                            } catch(e) {
                                                // non-JSON OK response, still treat as success
                                                el.remove();
                                                if (panel) panel.style.display = 'none';
                                            }
                                        } else {
                                            // try to show server-provided error message
                                            let msg = '{% trans "Could not delete allergy" %}';
                                            try { const err = await res.json(); if (err && err.error) msg = err.error; } catch(e){}
                                            alert(msg + ` (status ${res.status})`);
                                        }
                                    } catch (err) {
                                        console.error(err);
                                        alert('{% trans "An error occurred" %}');
                                    }
                                };
                            }
                            if (panel) panel.scrollIntoView({behavior: 'smooth'});
                        });
                    });

                    const addBtn = document.getElementById('addAllergyBtn');
                    if (addBtn) addBtn.addEventListener('click', () => {
                        window.scrollTo({top:0, behavior:'smooth'});
                        const input = document.getElementById('allergies');
                        if (input) input.focus();
                    });
                });
            </script>
    <h4 class="mt-4">{% trans "Your saved allergies" %}</h4>
        <div class="allergy-circles mt-3">
            {% for a in allergies %}
                <div class="allergy-circle" data-allergy-id="{{ a.id }}" data-description="{{ a.description|escapejs }}">
                    <div class="label">{{ a.name }}</div>
                    <div class="sub">{% trans "Tap to view" %}</div>
                </div>
            {% endfor %}
            <div class="allergy-main-circle" id="addAllergyBtn">+</div>
        </div>

        <div id="allergyDetails" class="allergy-details-panel">
            <h5 id="allergyDetailsTitle"></h5>
            <p id="allergyDetailsBody" class="small text-muted"></p>
        </div>

        {% if allergies|length == 0 %}
            <div class="text-muted">{% trans "No allergies saved yet." %}</div>
        {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

