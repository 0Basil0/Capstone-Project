{% extends 'base.html' %}
{% block title %}Home{% endblock %}

{% block content %}
<!-- page-wide backgrounds for breakfast (left), lunch (center), dinner (right) -->
<div class="page-bg">
    <div class="page-bg-item left" id="bg-breakfast"></div>
    <div class="page-bg-item center" id="bg-lunch"></div>
    <div class="page-bg-item right" id="bg-dinner"></div>
</div>
<div class="text-center mb-4">
    <div class="home-hero-panel mx-auto p-4 rounded-3" style="max-width:900px; background: rgba(0,0,0,0.55);">
        <h1 class="display-6 text-white mb-2">Today's Meal Planner</h1>
        <p class="text-light mb-0">Click the button to generate AI-powered suggestions for todays meals (Breakfast, Lunch, Dinner). Results are saved to your account.</p>
    </div>
</div>

<div class="d-flex justify-content-center gap-4 mb-4 meal-circles">
    <div class="meal-circle" id="breakfast">
        <div class="meal-label">Breakfast</div>
        <button class="close-expanded" aria-label="Close">×</button>
        <div class="meal-name" id="breakfast-name">{% if initial_plan %}{{ initial_plan.breakfast.name }}{% else %}—{% endif %}</div>
        <div class="meal-details" aria-hidden="true">
            <p class="small text-muted meal-ings" id="breakfast-ings"></p>
            <p class="small meal-desc" id="breakfast-desc"></p>
        </div>
    </div>
    <div class="meal-circle" id="lunch">
        <div class="meal-label">Lunch</div>
        <button class="close-expanded" aria-label="Close">×</button>
        <div class="meal-name" id="lunch-name">{% if initial_plan %}{{ initial_plan.lunch.name }}{% else %}—{% endif %}</div>
        <div class="meal-details" aria-hidden="true">
            <p class="small text-muted meal-ings" id="lunch-ings"></p>
            <p class="small meal-desc" id="lunch-desc"></p>
        </div>
    </div>
    <div class="meal-circle" id="dinner">
        <div class="meal-label">Dinner</div>
        <button class="close-expanded" aria-label="Close">×</button>
        <div class="meal-name" id="dinner-name">{% if initial_plan %}{{ initial_plan.dinner.name }}{% else %}—{% endif %}</div>
        <div class="meal-details" aria-hidden="true">
            <p class="small text-muted meal-ings" id="dinner-ings"></p>
            <p class="small meal-desc" id="dinner-desc"></p>
        </div>
    </div>
</div>

<!-- Modal to show ingredients/description -->
<div class="modal fade" id="mealModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mealModalLabel">Meal details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Ingredients:</strong></p>
                <p id="meal-ingredients" class="small text-muted"></p>
                <hr>
                <p><strong>Description:</strong></p>
                <p id="meal-description" class="small"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="text-center mb-5">
    <button id="generateBtn" class="btn btn-lg" style="background:#28a745; color:#fff; border:0; box-shadow:0 4px 10px rgba(0,0,0,0.25);">Generate today's plan</button>
    <div class="home-hero-panel mx-auto p-4 rounded-3 small text-light text-white" style="max-width:900px; background: rgba(0,0,0,0.55);">Meal suggestions are AI-generated and saved to your account.</div>
</div>

<script>
// Initialize UI from server-provided plan (if present)
const initialPlan = {{ initial_plan_json|default:'null'|safe }};
// preserve original state for each circle so we can restore when closing
const originalState = {};
['breakfast','lunch','dinner'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    originalState[id] = {
        name: document.getElementById(`${id}-name`)?.innerText || '',
        ingredients: el.dataset.ingredients || '',
        description: el.dataset.description || '',
        background: el.style.backgroundImage || '',
        color: el.style.color || '',
        textShadow: el.style.textShadow || ''
    };
});
if (initialPlan) {
    if (initialPlan.breakfast && initialPlan.breakfast.image) {
        document.getElementById('breakfast').style.backgroundImage = `linear-gradient(rgba(10,20,10,0.28), rgba(10,20,10,0.12)), url('${initialPlan.breakfast.image}')`;
        document.getElementById('bg-breakfast').style.backgroundImage = `linear-gradient(rgba(6,10,6,0.48), rgba(6,10,6,0.24)), url('${initialPlan.breakfast.image}')`;
        document.getElementById('bg-breakfast').style.opacity = '1';
        // Persist snapshot so closing restores this image
        originalState['breakfast'].background = document.getElementById('breakfast').style.backgroundImage || originalState['breakfast'].background;
        originalState['breakfast'].color = document.getElementById('breakfast').style.color || originalState['breakfast'].color;
        originalState['breakfast'].textShadow = document.getElementById('breakfast').style.textShadow || originalState['breakfast'].textShadow;
    }
    if (initialPlan.lunch && initialPlan.lunch.image) {
        document.getElementById('lunch').style.backgroundImage = `linear-gradient(rgba(10,20,10,0.28), rgba(10,20,10,0.12)), url('${initialPlan.lunch.image}')`;
        document.getElementById('bg-lunch').style.backgroundImage = `linear-gradient(rgba(6,10,6,0.48), rgba(6,10,6,0.24)), url('${initialPlan.lunch.image}')`;
        document.getElementById('bg-lunch').style.opacity = '1';
        originalState['lunch'].background = document.getElementById('lunch').style.backgroundImage || originalState['lunch'].background;
        originalState['lunch'].color = document.getElementById('lunch').style.color || originalState['lunch'].color;
        originalState['lunch'].textShadow = document.getElementById('lunch').style.textShadow || originalState['lunch'].textShadow;
    }
    if (initialPlan.dinner && initialPlan.dinner.image) {
        document.getElementById('dinner').style.backgroundImage = `linear-gradient(rgba(10,20,10,0.28), rgba(10,20,10,0.12)), url('${initialPlan.dinner.image}')`;
        document.getElementById('bg-dinner').style.backgroundImage = `linear-gradient(rgba(6,10,6,0.48), rgba(6,10,6,0.24)), url('${initialPlan.dinner.image}')`;
        document.getElementById('bg-dinner').style.opacity = '1';
        originalState['dinner'].background = document.getElementById('dinner').style.backgroundImage || originalState['dinner'].background;
        originalState['dinner'].color = document.getElementById('dinner').style.color || originalState['dinner'].color;
        originalState['dinner'].textShadow = document.getElementById('dinner').style.textShadow || originalState['dinner'].textShadow;
    }
    if (initialPlan.generation_count && initialPlan.generation_count >= 2) {
        const btn = document.getElementById('generateBtn');
        btn.innerText = 'Limit reached for today';
        btn.disabled = true;
    }
    // set dataset fields so modal works on initial load
    if (initialPlan.breakfast) {
        const el = document.getElementById('breakfast');
        el.dataset.ingredients = initialPlan.breakfast.ingredients || '';
        el.dataset.description = initialPlan.breakfast.description || '';
    }
    if (initialPlan.lunch) {
        const el = document.getElementById('lunch');
        el.dataset.ingredients = initialPlan.lunch.ingredients || '';
        el.dataset.description = initialPlan.lunch.description || '';
    }
    if (initialPlan.dinner) {
        const el = document.getElementById('dinner');
        el.dataset.ingredients = initialPlan.dinner.ingredients || '';
        el.dataset.description = initialPlan.dinner.description || '';
    }
}

async function generatePlan() {
    const btn = document.getElementById('generateBtn');
    btn.disabled = true;
    btn.innerText = 'Generating...';
    try {
        function getCookie(name) {
            let v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return v ? v.pop() : '';
        }
        const csrftoken = getCookie('csrftoken');
        const res = await fetch('{% url 'generate_meals' %}', {method: 'POST', headers: {'X-CSRFToken': csrftoken}});
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        document.getElementById('breakfast-name').innerText = data.breakfast.name || '—';
        document.getElementById('lunch-name').innerText = data.lunch.name || '—';
        document.getElementById('dinner-name').innerText = data.dinner.name || '—';

        // Apply background images with soft overlay to circles
        function setCircleImage(id, imageUrl) {
            const el = document.getElementById(id);
            if (!el) return;
            if (imageUrl) {
                el.style.backgroundImage = `linear-gradient(rgba(10,20,10,0.28), rgba(10,20,10,0.12)), url('${imageUrl}')`;
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
                el.style.color = '#fff';
                el.style.textShadow = '0 2px 6px rgba(0,0,0,0.5)';
            } else {
                el.style.backgroundImage = '';
                el.style.color = '';
                el.style.textShadow = '';
            }
        }

        setCircleImage('breakfast', data.breakfast.image);
        setCircleImage('lunch', data.lunch.image);
        setCircleImage('dinner', data.dinner.image);

        // Snapshot the newly-applied images so closing restores them instead of clearing
        ['breakfast','lunch','dinner'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            originalState[id].background = el.style.backgroundImage || originalState[id].background;
            originalState[id].color = el.style.color || originalState[id].color;
            originalState[id].textShadow = el.style.textShadow || originalState[id].textShadow;
        });

    // store meal details as data attributes for modal
    document.getElementById('breakfast').dataset.ingredients = data.breakfast.ingredients || '';
    document.getElementById('breakfast').dataset.description = data.breakfast.description || '';
    document.getElementById('lunch').dataset.ingredients = data.lunch.ingredients || '';
    document.getElementById('lunch').dataset.description = data.lunch.description || '';
    document.getElementById('dinner').dataset.ingredients = data.dinner.ingredients || '';
    document.getElementById('dinner').dataset.description = data.dinner.description || '';

        // set page-wide backgrounds
        function setPageBg(id, url) {
            const el = document.getElementById(id);
            if (!el) return;
            if (url) {
                el.style.backgroundImage = `linear-gradient(rgba(6,10,6,0.48), rgba(6,10,6,0.24)), url('${url}')`;
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
                el.style.opacity = '1';
            } else {
                el.style.backgroundImage = '';
                el.style.opacity = '0';
            }
        }

        setPageBg('bg-breakfast', data.breakfast.image);
        setPageBg('bg-lunch', data.lunch.image);
        setPageBg('bg-dinner', data.dinner.image);

        // show notice if generation limit reached
        if (data.generation_count && data.generation_count >= 2) {
            btn.innerText = 'Limit reached for today';
            btn.disabled = true;
        }
    } catch (e) {
        alert('Could not generate meals.');
    } finally {
        btn.disabled = false;
        btn.innerText = "Generate today's plan";
    }
}

document.getElementById('generateBtn').addEventListener('click', generatePlan);

// Attach click handlers to circles to expand them and show inline details
function collapseAll() {
    ['breakfast','lunch','dinner'].forEach(i => {
        const elx = document.getElementById(i);
        if (!elx) return;
        elx.classList.remove('expanded');
        const details = elx.querySelector('.meal-details');
        if (details) details.setAttribute('aria-hidden', 'true');
        // restore original visible text and styles
        const orig = originalState[i];
        if (orig) {
            const nameEl = document.getElementById(`${i}-name`);
            if (nameEl) nameEl.innerText = orig.name || '—';
            const ingsEl = elx.querySelector('.meal-ings');
            if (ingsEl) ingsEl.innerText = '';
            const descEl = elx.querySelector('.meal-desc');
            if (descEl) descEl.innerText = '';
            elx.style.backgroundImage = orig.background || '';
            elx.style.color = orig.color || '';
            elx.style.textShadow = orig.textShadow || '';
        }
    });
}

['breakfast','lunch','dinner'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.style.cursor = 'pointer';
    el.addEventListener('click', (ev) => {
        // if the user clicked the close button, don't expand
        if (ev.target && ev.target.classList && ev.target.classList.contains('close-expanded')) return;
        const isExpanded = el.classList.contains('expanded');
        // collapse others
        collapseAll();
        if (!isExpanded) {
            // populate inline details
            const ings = el.dataset.ingredients || '';
            const desc = el.dataset.description || '';
            const ingsEl = el.querySelector('.meal-ings');
            const descEl = el.querySelector('.meal-desc');
            if (ingsEl) ingsEl.innerText = ings || 'No ingredients available.';
            if (descEl) descEl.innerText = desc || 'No description available.';
            el.classList.add('expanded');
            const details = el.querySelector('.meal-details');
            if (details) details.setAttribute('aria-hidden', 'false');
        }
    });
    // close button handler
    const closeBtn = el.querySelector('.close-expanded');
    if (closeBtn) {
        closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            // restore this circle to original state
            const orig = originalState[id];
            if (orig) {
                const nameEl = document.getElementById(`${id}-name`);
                if (nameEl) nameEl.innerText = orig.name || '—';
                const ingsEl = el.querySelector('.meal-ings');
                if (ingsEl) ingsEl.innerText = '';
                const descEl = el.querySelector('.meal-desc');
                if (descEl) descEl.innerText = '';
                el.style.backgroundImage = orig.background || '';
                el.style.color = orig.color || '';
                el.style.textShadow = orig.textShadow || '';
            }
            el.classList.remove('expanded');
            const details = el.querySelector('.meal-details');
            if (details) details.setAttribute('aria-hidden', 'true');
        });
    }
});
</script>

{% endblock %}