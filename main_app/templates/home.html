{% extends 'base.html' %}
{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% block title %}{% trans "Home" %}{% endblock %}

{% block content %}
<nav class=" navbar-expand-lg navbar-dark bg-success shadow-sm">
    <div class="container">
    <!-- History toggle moved into navbar for consistent placement -->
     {% if LANGUAGE_CODE|slice:":2" == 'ar' %}
        <button id="historyToggleBtn" class="history-toggle" aria-expanded="false" aria-controls="mealHistorySidebar" aria-label="Open history"><span class="history-arrow">‹</span></button>
     {% endif %}
     {% if LANGUAGE_CODE|slice:":2" == 'en' %}
        <button id="historyToggleBtn" class="history-toggle" aria-expanded="false" aria-controls="mealHistorySidebar" aria-label="Open history"><span class="history-arrow">›</span></button>
     {% endif %}

</div>
</nav>
<!-- page-wide backgrounds for breakfast (left), lunch (center), dinner (right) -->
<div class="page-bg">
    <div class="page-bg-item left" id="bg-breakfast"></div>
    <div class="page-bg-item center" id="bg-lunch"></div>
    <div class="page-bg-item right" id="bg-dinner"></div>
</div>
<div class="text-center mb-4">
    <div class="home-hero-panel mx-auto p-4 rounded-3" style="max-width:900px; background: rgba(0,0,0,0.55);">
    <h1 class="display-6 text-white mb-2">{% trans "Today's Meal Planner" %}</h1>
    <p class="text-light mb-0">{% trans "Click the button to generate AI-powered suggestions for today's meals (Breakfast, Lunch, Dinner). Resulting ingredients/description are saved to your account." %}</p>
    </div>
</div>  
<!-- Left collapsible history sidebar (in DOM early so screen-readers can find it) -->
<aside id="mealHistorySidebar" class="history-sidebar" aria-hidden="false">
    <button id="historyCloseBtn" class="history-close" aria-label="Close history">×</button>
    <div class="history-inner p-3">
        <h6 class="mb-2">{% trans "Recent generated meals" %}</h6>
        {% if food_history %}
            <div class="list-group">
                {% for entry in food_history %}
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div>
                            <div style="font-weight:700">{{ entry.day }}</div>
                            <div class="small weight">
                                {% if entry.breakfast %}
                                    <span>{% trans "Breakfast" %}: {% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ entry.breakfast.name.ar }}{% else %}{{ entry.breakfast.name.en }}{% endif %}</span>
                                {% endif %}
                                {% if entry.lunch %}
                                    &nbsp;•&nbsp;<span>{% trans "Lunch" %}: {% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ entry.lunch.name.ar }}{% else %}{{ entry.lunch.name.en }}{% endif %}</span>
                                {% endif %}
                                {% if entry.dinner %}
                                    &nbsp;•&nbsp;<span>{% trans "Dinner" %}: {% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ entry.dinner.name.ar }}{% else %}{{ entry.dinner.name.en }}{% endif %}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            {% if entry.breakfast.image or entry.lunch.image or entry.dinner.image %}
                                <img src="{{ entry.breakfast.image|default:entry.lunch.image|default:entry.dinner.image }}" alt="" style="width:64px; height:44px; object-fit:cover; border-radius:6px;"/>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-muted small">{% trans "No recent generated meals yet." %}</div>
        {% endif %}
    </div>
</aside>

<div class="d-flex justify-content-center gap-4 mb-4 meal-circles">
    <div class="meal-circle" id="breakfast">
    <div class="meal-label">{% trans "Breakfast" %}</div>
        <button class="close-expanded" aria-label="Close">×</button>
        <div class="meal-details" aria-hidden="true">
            <div class="meal-name" id="breakfast-name">{% if initial_plan %}{% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ initial_plan.breakfast.name.ar }}{% else %}{{ initial_plan.breakfast.name.en }}{% endif %}{% else %}—{% endif %}</div>
            <p class="small weight meal-ings" id="breakfast-ings">{% if initial_plan %}{% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ initial_plan.breakfast.ingredients.ar }}{% else %}{{ initial_plan.breakfast.ingredients.en }}{% endif %}{% endif %}</p>
            <p class="small meal-desc" id="breakfast-desc">{% if initial_plan %}{% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ initial_plan.breakfast.description.ar }}{% else %}{{ initial_plan.breakfast.description.en }}{% endif %}{% endif %}</p>
        </div>
    </div>
    <div class="meal-circle" id="lunch">
    <div class="meal-label">{% trans "Lunch" %}</div>
        <button class="close-expanded" aria-label="Close">×</button>
        <div class="meal-details" aria-hidden="true">
            <div class="meal-name" id="lunch-name">{% if initial_plan %}{% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ initial_plan.lunch.name.ar }}{% else %}{{ initial_plan.lunch.name.en }}{% endif %}{% else %}—{% endif %}</div>
            <p class="small weight meal-ings" id="lunch-ings">{% if initial_plan %}{% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ initial_plan.lunch.ingredients.ar }}{% else %}{{ initial_plan.lunch.ingredients.en }}{% endif %}{% endif %}</p>
            <p class="small meal-desc" id="lunch-desc">{% if initial_plan %}{% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ initial_plan.lunch.description.ar }}{% else %}{{ initial_plan.lunch.description.en }}{% endif %}{% endif %}</p>
        </div>
    </div>
    <div class="meal-circle" id="dinner">
    <div class="meal-label">{% trans "Dinner" %}</div>
        <button class="close-expanded" aria-label="Close">×</button>
        <div class="meal-details" aria-hidden="true">
            <div class="meal-name" id="dinner-name">{% if initial_plan %}{% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ initial_plan.dinner.name.ar }}{% else %}{{ initial_plan.dinner.name.en }}{% endif %}{% else %}—{% endif %}</div>
            <p class="small weight meal-ings" id="dinner-ings">{% if initial_plan %}{% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ initial_plan.dinner.ingredients.ar }}{% else %}{{ initial_plan.dinner.ingredients.en }}{% endif %}{% endif %}</p>
            <p class="small meal-desc" id="dinner-desc">{% if initial_plan %}{% if LANGUAGE_CODE|slice:":2" == 'ar' %}{{ initial_plan.dinner.description.ar }}{% else %}{{ initial_plan.dinner.description.en }}{% endif %}{% endif %}</p>
        </div>
    </div>
</div>

<!-- Modal to show ingredients/description -->
<div class="modal fade" id="mealModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mealModalLabel">{% trans "Meal details" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>{% trans "Ingredients:" %}</strong></p>
                <p id="meal-ingredients" class="small text-muted"></p>
                <hr>
                <p><strong>{% trans "Description:" %}</strong></p>
                <p id="meal-description" class="small"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
            </div>
        </div>
    </div>
</div>

<div class="text-center mb-5">
    <button id="generateBtn" class="btn btn-lg" style="background:#28a745; color:#fff; border:0; box-shadow:0 4px 10px rgba(0,0,0,0.25);">{% trans "Generate today's plan" %}</button>
    <div class="home-hero-panel mx-auto p-4 rounded-3 small text-light text-white" style="max-width:500px; background: rgba(0,0,0,0.55);">{% trans "Meal suggestions are AI-generated and saved to your account." %}</div>
</div>

<script>

    
// Initialize UI from server-provided plan (if present)
const initialPlan = {{ initial_plan_json|default:'null'|safe }};
// current language code (from server)
const CURRENT_LANG = '{{ LANGUAGE_CODE }}' || 'en';

// helper to pick the right language value from either a string or {en,ar} object
function pickLangValue(v) {
    if (!v) return '';
    if (typeof v === 'string') return v;
    const code = (CURRENT_LANG || 'en').substring(0,2);
    return (v[code] || v['en'] || Object.values(v)[0] || '')
}

// preserve original state for each circle so we can restore when closing
const originalState = {};
['breakfast','lunch','dinner'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    originalState[id] = {
        name: document.getElementById(`${id}-name`)?.innerText || '',
        ingredients: el.dataset.ingredients || '',
        description: el.dataset.description || '',
        background: el.style.backgroundImage || '',
        color: el.style.color || '',
        textShadow: el.style.textShadow || ''
    };
});
if (initialPlan) {
    if (initialPlan.breakfast && initialPlan.breakfast.image) {
        document.getElementById('breakfast').style.backgroundImage = `linear-gradient(rgba(10,20,10,0.28), rgba(10,20,10,0.12)), url('${initialPlan.breakfast.image}')`;
        document.getElementById('bg-breakfast').style.backgroundImage = `linear-gradient(rgba(6,10,6,0.48), rgba(6,10,6,0.24)), url('${initialPlan.breakfast.image}')`;
        document.getElementById('bg-breakfast').style.opacity = '1';
        // Persist snapshot so closing restores this image
        originalState['breakfast'].background = document.getElementById('breakfast').style.backgroundImage || originalState['breakfast'].background;
        originalState['breakfast'].color = document.getElementById('breakfast').style.color || originalState['breakfast'].color;
        originalState['breakfast'].textShadow = document.getElementById('breakfast').style.textShadow || originalState['breakfast'].textShadow;
    }
    if (initialPlan.lunch && initialPlan.lunch.image) {
        document.getElementById('lunch').style.backgroundImage = `linear-gradient(rgba(10,20,10,0.28), rgba(10,20,10,0.12)), url('${initialPlan.lunch.image}')`;
        document.getElementById('bg-lunch').style.backgroundImage = `linear-gradient(rgba(6,10,6,0.48), rgba(6,10,6,0.24)), url('${initialPlan.lunch.image}')`;
        document.getElementById('bg-lunch').style.opacity = '1';
        originalState['lunch'].background = document.getElementById('lunch').style.backgroundImage || originalState['lunch'].background;
        originalState['lunch'].color = document.getElementById('lunch').style.color || originalState['lunch'].color;
        originalState['lunch'].textShadow = document.getElementById('lunch').style.textShadow || originalState['lunch'].textShadow;
    }
    if (initialPlan.dinner && initialPlan.dinner.image) {
        document.getElementById('dinner').style.backgroundImage = `linear-gradient(rgba(10,20,10,0.28), rgba(10,20,10,0.12)), url('${initialPlan.dinner.image}')`;
        document.getElementById('bg-dinner').style.backgroundImage = `linear-gradient(rgba(6,10,6,0.48), rgba(6,10,6,0.24)), url('${initialPlan.dinner.image}')`;
        document.getElementById('bg-dinner').style.opacity = '1';
        originalState['dinner'].background = document.getElementById('dinner').style.backgroundImage || originalState['dinner'].background;
        originalState['dinner'].color = document.getElementById('dinner').style.color || originalState['dinner'].color;
        originalState['dinner'].textShadow = document.getElementById('dinner').style.textShadow || originalState['dinner'].textShadow;
    }
    if (initialPlan.generation_count && initialPlan.generation_count >= 2) {
        const btn = document.getElementById('generateBtn');
        btn.innerText = 'Limit reached for today';
        btn.disabled = true;
    }
    // set dataset fields so modal works on initial load
    if (initialPlan.breakfast) {
        const el = document.getElementById('breakfast');
        el.dataset.ingredients = pickLangValue(initialPlan.breakfast.ingredients) || '';
        el.dataset.description = pickLangValue(initialPlan.breakfast.description) || '';
        document.getElementById('breakfast-name').innerText = pickLangValue(initialPlan.breakfast.name) || '—';
    }
    if (initialPlan.lunch) {
        const el = document.getElementById('lunch');
        el.dataset.ingredients = pickLangValue(initialPlan.lunch.ingredients) || '';
        el.dataset.description = pickLangValue(initialPlan.lunch.description) || '';
        document.getElementById('lunch-name').innerText = pickLangValue(initialPlan.lunch.name) || '—';
    }
    if (initialPlan.dinner) {
        const el = document.getElementById('dinner');
        el.dataset.ingredients = pickLangValue(initialPlan.dinner.ingredients) || '';
        el.dataset.description = pickLangValue(initialPlan.dinner.description) || '';
        document.getElementById('dinner-name').innerText = pickLangValue(initialPlan.dinner.name) || '—';
    }
}

async function generatePlan() {
    const btn = document.getElementById('generateBtn');
    btn.disabled = true;
    btn.innerText = 'Generating...';
    try {
        function getCookie(name) {
            let v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return v ? v.pop() : '';
        }
        const csrftoken = getCookie('csrftoken');
        const res = await fetch('{% url 'generate_meals' %}', {method: 'POST', headers: {'X-CSRFToken': csrftoken}});
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
    document.getElementById('breakfast-name').innerText = pickLangValue(data.breakfast.name) || '—';
    document.getElementById('lunch-name').innerText = pickLangValue(data.lunch.name) || '—';
    document.getElementById('dinner-name').innerText = pickLangValue(data.dinner.name) || '—';

        // Apply background images with soft overlay to circles
        function setCircleImage(id, imageUrl) {
            const el = document.getElementById(id);
            if (!el) return;
            if (imageUrl) {
                el.style.backgroundImage = `linear-gradient(rgba(10,20,10,0.28), rgba(10,20,10,0.12)), url('${imageUrl}')`;
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
                el.style.color = '#fff';
                el.style.textShadow = '0 2px 6px rgba(0,0,0,0.5)';
            } else {
                el.style.backgroundImage = '';
                el.style.color = '';
                el.style.textShadow = '';
            }
        }

        setCircleImage('breakfast', data.breakfast.image);
        setCircleImage('lunch', data.lunch.image);
        setCircleImage('dinner', data.dinner.image);

        // Snapshot the newly-applied images so closing restores them instead of clearing
        ['breakfast','lunch','dinner'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            originalState[id].background = el.style.backgroundImage || originalState[id].background;
            originalState[id].color = el.style.color || originalState[id].color;
            originalState[id].textShadow = el.style.textShadow || originalState[id].textShadow;
        });

    // store meal details as data attributes for modal
    document.getElementById('breakfast').dataset.ingredients = pickLangValue(data.breakfast.ingredients) || '';
    document.getElementById('breakfast').dataset.description = pickLangValue(data.breakfast.description) || '';
    document.getElementById('lunch').dataset.ingredients = pickLangValue(data.lunch.ingredients) || '';
    document.getElementById('lunch').dataset.description = pickLangValue(data.lunch.description) || '';
    document.getElementById('dinner').dataset.ingredients = pickLangValue(data.dinner.ingredients) || '';
    document.getElementById('dinner').dataset.description = pickLangValue(data.dinner.description) || '';

        // set page-wide backgrounds
        function setPageBg(id, url) {
            const el = document.getElementById(id);
            if (!el) return;
            if (url) {
                el.style.backgroundImage = `linear-gradient(rgba(6,10,6,0.48), rgba(6,10,6,0.24)), url('${url}')`;
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
                el.style.opacity = '1';
            } else {
                el.style.backgroundImage = '';
                el.style.opacity = '0';
            }
        }

        setPageBg('bg-breakfast', data.breakfast.image);
        setPageBg('bg-lunch', data.lunch.image);
        setPageBg('bg-dinner', data.dinner.image);

        // show notice if generation limit reached
        if (data.generation_count && data.generation_count >= 2) {
            btn.innerText = 'Limit reached for today';
            btn.disabled = true;
        }
    } catch (e) {
        alert('Could not generate meals.');
    } finally {
        btn.disabled = false;
        btn.innerText = "Generate today's plan";
    }
}

document.getElementById('generateBtn').addEventListener('click', generatePlan);

// Sidebar toggle: persist collapse state in localStorage + mobile handling
(function () {
    const btn = document.getElementById('historyToggleBtn');
    const sidebar = document.getElementById('mealHistorySidebar');
    const closeBtn = document.getElementById('historyCloseBtn');
    if (!btn || !sidebar) return;

    function disableBodyScroll(disable) {
        if (disable) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
    }

    function setHidden(hidden) {
        if (hidden) {
            sidebar.classList.add('hidden');
            sidebar.setAttribute('aria-hidden', 'true');
            btn.setAttribute('aria-expanded', 'false');
            // restore scrolling
            disableBodyScroll(false);
        } else {
            sidebar.classList.remove('hidden');
            sidebar.setAttribute('aria-hidden', 'false');
            btn.setAttribute('aria-expanded', 'true');
            // on small screens disable page scroll so the drawer feels modal
            if (window.innerWidth <= 768) disableBodyScroll(true);
        }
        try { localStorage.setItem('mealHistoryHidden', hidden ? '1' : '0'); } catch (e) {}
    }

    btn.addEventListener('click', (e) => {
        e.preventDefault();
        const isHidden = sidebar.classList.contains('hidden');
        setHidden(!isHidden);
    });

    if (closeBtn) {
        closeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            setHidden(true);
        });
    }

    // initialize from localStorage (default: visible)
    try {
        const v = localStorage.getItem('mealHistoryHidden');
        if (v === '1') setHidden(true);
    } catch (e) {}

    // on resize, ensure we re-evaluate scroll locking
    window.addEventListener('resize', () => {
        if (sidebar.classList.contains('hidden')) {
            disableBodyScroll(false);
        } else {
            if (window.innerWidth <= 768) disableBodyScroll(true); else disableBodyScroll(false);
        }
    });

    // default: hide on small screens (but keep user's persisted choice)
    try {
        const persisted = localStorage.getItem('mealHistoryHidden');
        if (persisted === null && window.innerWidth <= 768) {
            setHidden(true);
        }
    } catch (e) {}
})();

// Attach click handlers to circles to expand them and show inline details
function collapseAll() {
    ['breakfast','lunch','dinner'].forEach(i => {
        const elx = document.getElementById(i);
        if (!elx) return;
        elx.classList.remove('expanded');
        const details = elx.querySelector('.meal-details');
        if (details) details.setAttribute('aria-hidden', 'true');
        // restore original visible text and styles
        const orig = originalState[i];
        if (orig) {
            const nameEl = document.getElementById(`${i}-name`);
            if (nameEl) nameEl.innerText = orig.name || '—';
            const ingsEl = elx.querySelector('.meal-ings');
            if (ingsEl) ingsEl.innerText = '';
            const descEl = elx.querySelector('.meal-desc');
            if (descEl) descEl.innerText = '';
            elx.style.backgroundImage = orig.background || '';
            elx.style.color = orig.color || '';
            elx.style.textShadow = orig.textShadow || '';
        }
    });
}

['breakfast','lunch','dinner'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.style.cursor = 'pointer';
    el.addEventListener('click', (ev) => {
        // if the user clicked the close button, don't expand
        if (ev.target && ev.target.classList && ev.target.classList.contains('close-expanded')) return;
        const isExpanded = el.classList.contains('expanded');
        // collapse others
        collapseAll();
        if (!isExpanded) {
            // populate inline details
            const ings = el.dataset.ingredients || '';
            const desc = el.dataset.description || '';
            const ingsEl = el.querySelector('.meal-ings');
            const descEl = el.querySelector('.meal-desc');
            if (ingsEl) ingsEl.innerText = ings || 'No ingredients available.';
            if (descEl) descEl.innerText = desc || 'No description available.';
            el.classList.add('expanded');
            const details = el.querySelector('.meal-details');
            if (details) details.setAttribute('aria-hidden', 'false');
        }
    });
    // close button handler
    const closeBtn = el.querySelector('.close-expanded');
    if (closeBtn) {
        closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            // restore this circle to original state
            const orig = originalState[id];
            if (orig) {
                const nameEl = document.getElementById(`${id}-name`);
                if (nameEl) nameEl.innerText = orig.name || '—';
                const ingsEl = el.querySelector('.meal-ings');
                if (ingsEl) ingsEl.innerText = '';
                const descEl = el.querySelector('.meal-desc');
                if (descEl) descEl.innerText = '';
                el.style.backgroundImage = orig.background || '';
                el.style.color = orig.color || '';
                el.style.textShadow = orig.textShadow || '';
            }
            el.classList.remove('expanded');
            const details = el.querySelector('.meal-details');
            if (details) details.setAttribute('aria-hidden', 'true');
        });
    }
});
</script>

{% endblock %}